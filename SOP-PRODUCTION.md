# Standard Operating Procedure (SOP)
# Deploy Chatzwa Production dengan Dockploy

## Overview
Dokumen ini memberikan panduan lengkap untuk deploy aplikasi Chatzwa di lingkungan production menggunakan Dockploy. Aplikasi ini adalah Next.js 14 dengan TypeScript, Tailwind CSS, dan integrasi AI.

## Prerequisites

### Environment Requirements
- **Node.js**: >= 18.17.0
- **Memory**: Minimum 2GB RAM, Recommended 4GB+
- **Storage**: Minimum 10GB available space
- **Network**: Stable internet connection for AI API calls

### Required Environment Variables
```bash
# Core Application
NODE_ENV=production
NEXT_TELEMETRY_DISABLED=1

# Database
DATABASE_URL="file:./database.db" # SQLite production database

# AI Service Configuration (choose one)
# Option 1: ZAI API (Cloud)
ZAI_API_KEY="your-zai-api-key"
ZAI_API_URL="https://api.z.ai/v1"

# Option 2: Ollama (Local)
OLLAMA_BASE_URL="http://localhost:11434"
OLLAMA_MODEL="llama2" # or your preferred model

# Security & Performance
NEXTAUTH_SECRET="your-secure-secret-key"
NEXTAUTH_URL="https://your-domain.com"

# Optional: Analytics & Monitoring
SENTRY_DSN="your-sentry-dsn" # Error tracking
ANALYTICS_API_KEY="your-analytics-key" # Usage analytics

# Custom Application Variables
CUSTOM_KEY="your-custom-key"
```

## Deployment Process

### 1. Preparation Phase

#### 1.1 Code Quality Checks
```bash
# Run linting (must pass)
npm run lint

# Run TypeScript checks (must pass)
npm run type-check

# Run build test locally
npm run build

# Test production build locally
npm run start
```

#### 1.2 Database Preparation
```bash
# Push latest schema changes
npm run db:push

# Generate updated Prisma client
npm run db:generate

# Backup existing database (if applicable)
cp database.db database-backup-$(date +%Y%m%d-%H%M%S).db
```

#### 1.3 Asset Optimization
```bash
# Verify image optimization settings are appropriate
# Check next.config.ts image configuration

# Test application in production mode
npm run build
npm run start
```

### 2. Dockploy Configuration

#### 2.1 Build Configuration
Create `nixpacks.toml` in root:
```toml
[phases.setup]
nixPkgs = ["nodejs-18", "git"]

[phases.install]
cmds = ["npm ci --only=production"]

[start]
cmd = "npm start"

[variables]
NODE_ENV = "production"
NEXT_TELEMETRY_DISABLED = "1"

[deploy]
healthcheckPath = "/api/health"
healthcheckTimeout = 300
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3
```

#### 2.2 Dockploy Environment Setup
1. **Repository Connection**: Connect your Git repository
2. **Branch Selection**: Use `main` or `production` branch
3. **Build Context**: Root directory
4. **Output Directory**: `.next` (auto-generated by standalone output)
5. **Port Configuration**: Port 3000

#### 2.3 Resource Allocation
```yaml
# Recommended Dockploy resource settings
resources:
  memory: "2048Mi" # 2GB minimum
  cpu: "1000m"     # 1 CPU core minimum
  storage: "10Gi"  # 10GB minimum

# For high-traffic deployments
resources:
  memory: "4096Mi" # 4GB recommended
  cpu: "2000m"     # 2 CPU cores recommended
  storage: "20Gi"  # 20GB recommended
```

### 3. Build & Deployment Pipeline

#### 3.1 CI/CD Pipeline Steps

```yaml
# .github/workflows/deploy.yml
name: Production Deploy

on:
  push:
    branches: [main, production]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Type check
        run: npm run type-check

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Run tests
        run: npm test

      - name: Deploy to Dockploy
        uses: your-dockploy-action@v1
        with:
          api-key: ${{ secrets.DOCKPLOY_API_KEY }}
          project-id: ${{ secrets.DOCKPLOY_PROJECT_ID }}
```

#### 3.2 Build Optimization Features

The `next.config.ts` is optimized for production with:

- **Standalone Output**: `output: 'standalone'` for containerized deployment
- **Code Splitting**: Optimized bundle sizes with intelligent chunking
- **Image Optimization**: WebP/AVIF formats with caching strategies
- **Security Headers**: Production-grade security headers
- **Performance Caching**: Optimized static asset caching
- **TypeScript Enforcement**: Strict type checking in production builds
- **Tree Shaking**: Removal of unused code and dependencies

### 4. Post-Deployment Verification

#### 4.1 Health Checks
```bash
# Basic health check
curl https://your-domain.com/api/health

# Expected response:
# {"status":"ok","timestamp":"2024-01-01T00:00:00.000Z","uptime":12345}

# Application functionality check
curl -X POST https://your-domain.com/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"Hello"}'
```

#### 4.2 Performance Monitoring
- **Load Time**: < 3 seconds for initial page load
- **Time to Interactive**: < 5 seconds
- **Lighthouse Score**: > 90 for all categories
- **Memory Usage**: < 70% of allocated memory

#### 4.3 Security Verification
- **HTTPS**: SSL certificate valid and properly configured
- **Security Headers**: All security headers present
- **CORS**: Properly configured for allowed origins
- **Environment Variables**: No sensitive data exposed

### 5. Monitoring & Maintenance

#### 5.1 Key Metrics to Monitor
```javascript
// Essential monitoring points
const metrics = {
  // Performance
  responseTime: '< 2s',
  cpuUsage: '< 80%',
  memoryUsage: '< 80%',
  diskUsage: '< 85%',

  // Application
  errorRate: '< 1%',
  uptime: '> 99.9%',
  apiSuccessRate: '> 99%',

  // Business
  activeUsers: 'Track trends',
  chatEngagement: 'Monitor usage patterns',
  knowledgeBaseQueries: 'Track RAG performance'
};
```

#### 5.2 Log Monitoring
```bash
# Application logs monitoring
tail -f /var/log/app/server.log | grep -E "(ERROR|WARN)"

# Dockploy logs via dashboard or API
# Monitor for deployment issues, health check failures, etc.

# Database performance logs
# Monitor query performance, connection counts
```

#### 5.3 Backup Strategy
```bash
# Database backup (automated)
0 2 * * * cp /app/database.db /app/backups/database-$(date +\%Y\%m\%d-\%H\%M\%S).db

# Keep last 30 days of backups
0 3 * * * find /app/backups -name "database-*.db" -mtime +30 -delete

# Configuration backup
# Store environment variables securely
# Backup next.config.ts and other critical configs
```

## Troubleshooting Guide

### Common Issues & Solutions

#### 1. Build Failures
```bash
# Issue: TypeScript errors
Solution: Fix all TypeScript errors, update next.config.ts if needed

# Issue: Memory exceeded during build
Solution: Increase build memory limit in Dockploy settings
Check for memory leaks in code, optimize images/assets

# Issue: Dependency conflicts
Solution: Clean npm cache, update package-lock.json
Verify compatibility of all dependencies
```

#### 2. Runtime Issues
```bash
# Issue: Application won't start
Check: Environment variables, database connection, port conflicts
Solution: Verify all required env vars are set, check database accessibility

# Issue: Slow performance
Check: Database queries, AI API response times, memory usage
Solution: Optimize database queries, implement caching, scale resources

# Issue: AI service not responding
Check: API keys, service availability, network connectivity
Solution: Verify credentials, test API endpoints, implement fallback
```

#### 3. Deployment Issues
```bash
# Issue: Health check failures
Check: /api/health endpoint, application startup sequence
Solution: Ensure health endpoint responds correctly, fix startup issues

# Issue: Container restart loops
Check: Memory limits, application errors, resource constraints
Solution: Increase memory allocation, fix application errors
```

## Emergency Procedures

### 1. Immediate Response
1. **Identify Issue**: Check logs, monitor alerts
2. **Assess Impact**: Determine user impact and business continuity
3. **Communicate**: Notify stakeholders of issues and ETA
4. **Implement Fix**: Apply rollback or hotfix as appropriate

### 2. Rollback Procedure
```bash
# Emergency rollback to previous stable version
1. Access Dockploy dashboard
2. Navigate to deployment history
3. Select last stable deployment
4. Click rollback
5. Verify application functionality
6. Monitor for issues
```

### 3. Communication Protocol
- **Critical Issues**: Immediate notification to all stakeholders
- **Performance Degradation**: Alert team, monitor user feedback
- **Scheduled Maintenance**: 24-hour advance notice to users

## Security Considerations

### 1. Environment Security
- Never commit sensitive environment variables to Git
- Use Dockploy's secure environment variable storage
- Regularly rotate API keys and secrets
- Implement IP whitelisting where possible

### 2. Application Security
- Regular security updates: `npm audit fix`
- Monitor for Common Vulnerabilities and Exposures (CVEs)
- Implement rate limiting on API endpoints
- Use Content Security Policy (CSP) headers

### 3. Data Protection
- Regular database backups
- Encrypt sensitive data at rest and in transit
- Implement proper user authentication and authorization
- Comply with data protection regulations (GDPR, etc.)

## Performance Optimization

### 1. Build Optimization
- Leverage Next.js automatic code splitting
- Optimize images with WebP/AVIF formats
- Implement proper caching strategies
- Minimize JavaScript bundle size

### 2. Runtime Optimization
- Implement Redis caching for frequently accessed data
- Optimize database queries with proper indexing
- Use CDN for static assets
- Monitor and optimize AI API calls

### 3. Scaling Strategy
- Horizontal scaling for user traffic
- Vertical scaling for compute-intensive AI operations
- Load balancing for high availability
- Auto-scaling based on traffic patterns

## Documentation & Knowledge Management

### 1. Maintain Documentation
- Keep SOP-PRODUCTION.md up to date
- Document all configuration changes
- Maintain incident logs and lessons learned
- Regular review and update of procedures

### 2. Team Training
- Regular training on deployment procedures
- Knowledge sharing on troubleshooting techniques
- Cross-training for team redundancy
- Documentation of best practices

## Compliance & Governance

### 1. Change Management
- All changes require proper testing
- Peer review for production deployments
- Documentation of all changes
- Rollback plans for all deployments

### 2. Audit Requirements
- Maintain deployment logs
- Document security measures
- Regular security assessments
- Compliance with organizational policies

---

**Last Updated**: January 2024
**Next Review**: April 2024
**Maintained By**: Development Team
**Approved By**: Technical Lead

For questions or issues with this SOP, please contact the development team or create an issue in the project repository.