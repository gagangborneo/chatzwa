// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String   // Hashed password
  role      String   @default("user") // admin, user
  isActive  Boolean  @default(true)
  lastLoginAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  personas  Persona[]
  chatMessages ChatMessage[]
  whatsappIntegrations WhatsAppIntegration[]
  sessions  UserSession[]
  knowledgeCategories KnowledgeCategory[]
  knowledgeDocuments  KnowledgeDocument[]
  documentUploads     DocumentUpload[]
}

// User Sessions for authentication
model UserSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique // Session token
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@index([isActive])
}

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String?
  published Boolean  @default(false)
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Persona {
  id                   String   @id @default(cuid())
  slug                 String?  @unique
  name                 String
  welcomeMessage       String
  selectedProfile      String   @default("islamic_educator")

  // Text Style Settings
  formality            String   @default("professional") // casual, professional, formal
  empathy              String   @default("high")          // low, medium, high
  enthusiasm           String   @default("medium")       // low, medium, high
  humor                String   @default("low")          // low, medium, high
  verbosity            String   @default("medium")       // concise, medium, detailed

  // Behavior Settings
  knowledgeDomain      String   @default("islamic_education") // islamic_education, general, education, religious
  languageStyle        String   @default("friendly")          // friendly, professional, academic, casual
  culturalContext      String   @default("indonesian")        // indonesian, islamic, western, neutral
  expertise            String   @default("general")           // general, intermediate, expert, scholar
  personality          String   @default("helpful")           // helpful, formal, friendly, teacher, guide

  // Response Settings
  maxLength            Int      @default(500)
  minResponseTime      Float    @default(1.0)
  maxResponseTime      Float    @default(5.0)
  useEmojis            Boolean  @default(true)
  includeGreeting      Boolean  @default(true)
  askFollowUp          Boolean  @default(true)

  // AI Settings
  systemPrompt         String   @default("")
  customInstructions   String   @default("")

  // Metadata
  isActive             Boolean  @default(false)
  createdBy            String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  userId               String?
  user                 User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  chatMessages         ChatMessage[]

  @@index([userId])
  @@index([slug])
  @@index([isActive])
  @@index([selectedProfile])
}

model ChatMessage {
  id            String   @id @default(cuid())
  sessionId     String
  message       String
  response      String
  personaId     String?
  userId        String?
  source        String   @default("web") // web, whatsapp, etc
  whatsappId    String?  // WhatsApp message ID

  // Metadata
  ip            String?
  userAgent     String?
  timestamp     DateTime @default(now())

  // Relations
  persona       Persona?             @relation(fields: [personaId], references: [id], onDelete: SetNull)
  user          User?                @relation(fields: [userId], references: [id], onDelete: SetNull)
  whatsappIntegration WhatsAppIntegration? @relation(fields: [whatsappId], references: [id], onDelete: SetNull)
  whatsappContact WhatsAppContact?  @relation(fields: [whatsappId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([timestamp])
  @@index([userId])
  @@index([personaId])
  @@index([source])
  @@index([whatsappId])
}

model WhatsAppIntegration {
  id            String   @id @default(cuid())
  name          String
  phoneNumber   String   @unique
  businessId    String?  // WhatsApp Business API ID
  accessToken   String?  // Encrypted access token
  apiKey        String?  // Encrypted API key
  webhookSecret String?  // Encrypted webhook secret
  status        String   @default("disconnected") // connected, disconnected, error, connecting
  lastSyncAt    DateTime @default(now())

  // Configuration
  autoRespond    Boolean  @default(true)
  welcomeMessage String   @default("")
  defaultMessage  String   @default("")

  // Statistics
  totalMessages  Int      @default(0)
  totalMedia     Int      @default(0)
  activeChats    Int      @default(0)

  // Metadata
  createdBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  contacts     WhatsAppContact[]
  media        WhatsAppMedia[]
  chatMessages ChatMessage[]

  @@index([userId])
  @@index([status])
  @@index([phoneNumber])
  @@index([lastSyncAt])
}

model WhatsAppContact {
  id              String   @id @default(cuid())
  integrationId   String
  phoneNumber     String   @unique
  name            String?
  profilePicture   String?
  isBlocked       Boolean  @default(false)
  isBusiness     Boolean  @default(false)
  lastMessageAt    DateTime?

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  integration     WhatsAppIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  messages        ChatMessage[]

  @@index([integrationId])
  @@index([phoneNumber])
  @@index([isBlocked])
}

model WhatsAppMedia {
  id              String   @id @default(cuid())
  integrationId   String
  messageId       String   // WhatsApp message ID
  contactId       String?
  mediaType       String   // image, video, audio, document, etc.
  mediaUrl        String   // Cloud storage URL
  originalName    String?
  mimeType       String?
  fileSize       Int?
  thumbnailUrl    String?

  // Metadata
  createdAt       DateTime @default(now())

  // Relations
  integration     WhatsAppIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([mediaType])
}

// Knowledge Management System
model KnowledgeCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  color       String   @default("#6B7280") // Hex color code
  icon        String?  // Icon name or emoji
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)

  // Metadata
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  documents   KnowledgeDocument[]
  creator     User?       @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([isActive])
  @@index([sortOrder])
}

model KnowledgeDocument {
  id            String   @id @default(cuid())
  title         String
  content       String   // Full text content
  description   String?  // Short description
  categoryId    String?
  author        String?  // Document author/uploader
  source        String?  // Source of document (web, upload, sync, etc.)
  filePath      String?  // File path if uploaded
  fileName      String?  // Original file name
  fileSize      Int?     // File size in bytes
  mimeType      String?  // MIME type
  format        String?  // Document format (PDF, DOCX, TXT, etc.)
  status        String   @default("draft") // draft, published, archived, processing
  isIndexed     Boolean  @default(false) // Whether document is indexed in RAG
  embeddingCount Int     @default(0)     // Number of embeddings created
  viewCount     Int      @default(0)     // Number of times viewed

  // RAG Integration
  ragDocumentId String?  // Document ID in RAG system
  lastIndexedAt DateTime? // Last time document was indexed

  // Search and SEO
  tags          String?  // Comma-separated tags
  keywords      String?  // Search keywords
  priority      Int      @default(0) // Search priority

  // Metadata
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  publishedAt   DateTime?

  // Relations
  category      KnowledgeCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  creator       User?               @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  uploadRecords DocumentUpload[]

  @@index([categoryId])
  @@index([status])
  @@index([isIndexed])
  @@index([createdAt])
  @@index([publishedAt])
  @@index([source])
}

model DocumentUpload {
  id            String   @id @default(cuid())
  fileName      String
  originalName  String
  fileSize      Int
  mimeType      String
  filePath      String
  status        String   @default("uploading") // uploading, processing, completed, failed
  errorMessage  String?
  processingLog String? // JSON log of processing steps

  // Processing Configuration
  autoIndex     Boolean  @default(true)
  categoryId    String?
  extractText   Boolean  @default(true) // Whether to extract text from file

  // Upload Metadata
  uploadSource  String   @default("manual") // manual, sync, api, etc.
  uploaderIp    String?
  userAgent     String?

  // Metadata
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  completedAt   DateTime?

  // Relations
  document       KnowledgeDocument? @relation(fields: [documentId], references: [id])
  documentId     String?
  uploader       User?               @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdBy])
  @@index([createdAt])
  @@index([documentId])
}