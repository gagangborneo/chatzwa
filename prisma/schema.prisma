// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String   // Hashed password
  role      String   @default("user") // admin, user
  isActive  Boolean  @default(true)
  lastLoginAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  personas  Persona[]
  chatMessages ChatMessage[]
  whatsappIntegrations WhatsAppIntegration[]
  sessions  UserSession[]
  knowledgeCategories KnowledgeCategory[]
  knowledgeDocuments  KnowledgeDocument[]
  documentUploads     DocumentUpload[]

  // Subscription Relations
  subscriptions Subscription[]
  transactions Transaction[]
  invoices Invoice[]
  chatbots Chatbot[]
}

// User Sessions for authentication
model UserSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique // Session token
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@index([isActive])
}

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String?
  published Boolean  @default(false)
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Persona {
  id                   String   @id @default(cuid())
  slug                 String?  @unique
  name                 String
  welcomeMessage       String
  selectedProfile      String   @default("islamic_educator")

  // Text Style Settings
  formality            String   @default("professional") // casual, professional, formal
  empathy              String   @default("high")          // low, medium, high
  enthusiasm           String   @default("medium")       // low, medium, high
  humor                String   @default("low")          // low, medium, high
  verbosity            String   @default("medium")       // concise, medium, detailed

  // Behavior Settings
  knowledgeDomain      String   @default("islamic_education") // islamic_education, general, education, religious
  languageStyle        String   @default("friendly")          // friendly, professional, academic, casual
  culturalContext      String   @default("indonesian")        // indonesian, islamic, western, neutral
  expertise            String   @default("general")           // general, intermediate, expert, scholar
  personality          String   @default("helpful")           // helpful, formal, friendly, teacher, guide

  // Response Settings
  maxLength            Int      @default(500)
  minResponseTime      Float    @default(1.0)
  maxResponseTime      Float    @default(5.0)
  useEmojis            Boolean  @default(true)
  includeGreeting      Boolean  @default(true)
  askFollowUp          Boolean  @default(true)

  // AI Settings
  systemPrompt         String   @default("")
  customInstructions   String   @default("")

  // Metadata
  isActive             Boolean  @default(false)
  createdBy            String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  userId               String?
  user                 User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  chatMessages         ChatMessage[]

  @@index([userId])
  @@index([slug])
  @@index([isActive])
  @@index([selectedProfile])
}

model ChatMessage {
  id            String   @id @default(cuid())
  sessionId     String
  message       String
  response      String
  personaId     String?
  userId        String?
  source        String   @default("web") // web, whatsapp, etc
  whatsappId    String?  // WhatsApp message ID

  // Metadata
  ip            String?
  userAgent     String?
  timestamp     DateTime @default(now())

  // Relations
  persona       Persona?             @relation(fields: [personaId], references: [id], onDelete: SetNull)
  user          User?                @relation(fields: [userId], references: [id], onDelete: SetNull)
  whatsappIntegration WhatsAppIntegration? @relation(fields: [whatsappId], references: [id], onDelete: SetNull)
  whatsappContact WhatsAppContact?  @relation(fields: [whatsappId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([timestamp])
  @@index([userId])
  @@index([personaId])
  @@index([source])
  @@index([whatsappId])
}

model WhatsAppIntegration {
  id            String   @id @default(cuid())
  name          String
  phoneNumber   String   @unique
  businessId    String?  // WhatsApp Business API ID
  accessToken   String?  // Encrypted access token
  apiKey        String?  // Encrypted API key
  webhookSecret String?  // Encrypted webhook secret
  status        String   @default("disconnected") // connected, disconnected, error, connecting
  lastSyncAt    DateTime @default(now())

  // Configuration
  autoRespond    Boolean  @default(true)
  welcomeMessage String   @default("")
  defaultMessage  String   @default("")

  // Statistics
  totalMessages  Int      @default(0)
  totalMedia     Int      @default(0)
  activeChats    Int      @default(0)

  // Metadata
  createdBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  contacts     WhatsAppContact[]
  media        WhatsAppMedia[]
  chatMessages ChatMessage[]

  @@index([userId])
  @@index([status])
  @@index([phoneNumber])
  @@index([lastSyncAt])
}

model WhatsAppContact {
  id              String   @id @default(cuid())
  integrationId   String
  phoneNumber     String   @unique
  name            String?
  profilePicture   String?
  isBlocked       Boolean  @default(false)
  isBusiness     Boolean  @default(false)
  lastMessageAt    DateTime?

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  integration     WhatsAppIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  messages        ChatMessage[]

  @@index([integrationId])
  @@index([phoneNumber])
  @@index([isBlocked])
}

model WhatsAppMedia {
  id              String   @id @default(cuid())
  integrationId   String
  messageId       String   // WhatsApp message ID
  contactId       String?
  mediaType       String   // image, video, audio, document, etc.
  mediaUrl        String   // Cloud storage URL
  originalName    String?
  mimeType       String?
  fileSize       Int?
  thumbnailUrl    String?

  // Metadata
  createdAt       DateTime @default(now())

  // Relations
  integration     WhatsAppIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([mediaType])
}

// Knowledge Management System
model KnowledgeCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  color       String   @default("#6B7280") // Hex color code
  icon        String?  // Icon name or emoji
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)

  // Metadata
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  documents   KnowledgeDocument[]
  creator     User?       @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([isActive])
  @@index([sortOrder])
}

model KnowledgeDocument {
  id            String   @id @default(cuid())
  title         String
  content       String   // Full text content
  description   String?  // Short description
  categoryId    String?
  author        String?  // Document author/uploader
  source        String?  // Source of document (web, upload, sync, etc.)
  filePath      String?  // File path if uploaded
  fileName      String?  // Original file name
  fileSize      Int?     // File size in bytes
  mimeType      String?  // MIME type
  format        String?  // Document format (PDF, DOCX, TXT, etc.)
  status        String   @default("draft") // draft, published, archived, processing
  isIndexed     Boolean  @default(false) // Whether document is indexed in RAG
  embeddingCount Int     @default(0)     // Number of embeddings created
  viewCount     Int      @default(0)     // Number of times viewed

  // RAG Integration
  ragDocumentId String?  // Document ID in RAG system
  lastIndexedAt DateTime? // Last time document was indexed

  // Search and SEO
  tags          String?  // Comma-separated tags
  keywords      String?  // Search keywords
  priority      Int      @default(0) // Search priority

  // Metadata
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  publishedAt   DateTime?

  // Relations
  category      KnowledgeCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  creator       User?               @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  uploadRecords DocumentUpload[]

  @@index([categoryId])
  @@index([status])
  @@index([isIndexed])
  @@index([createdAt])
  @@index([publishedAt])
  @@index([source])
}

model DocumentUpload {
  id            String   @id @default(cuid())
  fileName      String
  originalName  String
  fileSize      Int
  mimeType      String
  filePath      String
  status        String   @default("uploading") // uploading, processing, completed, failed
  errorMessage  String?
  processingLog String? // JSON log of processing steps

  // Processing Configuration
  autoIndex     Boolean  @default(true)
  categoryId    String?
  extractText   Boolean  @default(true) // Whether to extract text from file

  // Upload Metadata
  uploadSource  String   @default("manual") // manual, sync, api, etc.
  uploaderIp    String?
  userAgent     String?

  // Metadata
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  completedAt   DateTime?

  // Relations
  document       KnowledgeDocument? @relation(fields: [documentId], references: [id])
  documentId     String?
  uploader       User?               @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdBy])
  @@index([createdAt])
  @@index([documentId])
}

//========================================
// SUBSCRIPTION SYSTEM MODELS
//========================================

// Package Plans with Features
model Package {
  id                String   @id @default(cuid())
  name              String   @unique
  displayName       String   // Display name for UI
  description       String   // Package description
  price             Int      // Price in IDR
  billingCycle      String   // monthly, yearly, lifetime
  currency          String   @default("IDR")
  sortOrder         Int      @default(0)
  isActive          Boolean  @default(true)
  isPopular         Boolean  @default(false) // Highlight in pricing

  // Feature Limits
  maxChatbots       Int      @default(1)      // Max chatbot creation
  maxMessages       Int?     // Max messages per month, null = unlimited
  maxKnowledgeDocs  Int?     // Max knowledge base docs, null = unlimited
  maxTeamMembers    Int      @default(1)      // Max team members
  maxApiCalls       Int?     // Max API calls per month, null = unlimited

  // Feature Flags
  features          Json     // JSON object with feature flags
  apiAccess         Boolean  @default(false)
  whatsappIntegration Boolean @default(false)
  customDomain      Boolean  @default(false)
  prioritySupport   Boolean  @default(false)
  advancedAnalytics Boolean  @default(false)
  customBranding    Boolean  @default(false)
  exportData        Boolean  @default(false)
  ragSystem         Boolean  @default(false)

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  subscriptions Subscription[]

  @@index([isActive])
  @@index([billingCycle])
  @@index([sortOrder])
  @@index([price])
}

// User Subscriptions
model Subscription {
  id            String   @id @default(cuid())
  userId        String
  packageId     String
  status        String   @default("active") // active, inactive, cancelled, expired, suspended
  startDate     DateTime
  endDate       DateTime?
  nextBillingDate DateTime?
  cancelledAt   DateTime?
  cancellationReason String?

  // Usage Tracking
  currentUsage  Json?    // Current usage stats
  usageResetAt  DateTime? // When usage resets (monthly)

  // Billing Information
  basePrice     Int      // Base price in IDR
  discountAmount Int     @default(0)
  taxAmount     Int      @default(0)
  totalAmount   Int      // Total amount paid
  currency      String   @default("IDR")

  // Auto-renewal
  isAutoRenew   Boolean  @default(true)
  renewalAttempts Int   @default(0)
  maxRenewalAttempts Int @default(3)

  // Payment Gateway Integration
  externalSubscriptionId String? // External subscription ID from payment gateway
  paymentMethod String? // credit_card, bank_transfer, ewallet, etc

  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  package       Package    @relation(fields: [packageId], references: [id])
  transactions Transaction[]
  invoices Invoice[]
  chatbots Chatbot[]

  @@index([userId])
  @@index([packageId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([nextBillingDate])
  @@index([isAutoRenew])
}

// Financial Transactions
model Transaction {
  id              String   @id @default(cuid())
  userId          String
  subscriptionId  String?
  invoiceId       String?
  type            String   // subscription, renewal, upgrade, downgrade, setup_fee, overage
  amount          Int      // Amount in IDR
  currency        String   @default("IDR")
  status          String   @default("pending") // pending, processing, completed, failed, cancelled, refunded
  description     String   // Transaction description
  paymentMethod   String?  // credit_card, bank_transfer, ewallet, virtual_account, etc

  // Payment Gateway Integration
  externalTransactionId String? // External transaction ID from payment gateway
  paymentGateway  String?  // midtrans, xendit, doku, stripe, etc
  gatewayResponse Json?    // Full response from payment gateway
  paymentUrl      String?  // Payment URL for user to complete payment
  expiredAt       DateTime? // Payment expiration time

  // Billing Details
  baseAmount      Int      // Base amount before discounts/taxes
  discountAmount  Int      @default(0)
  taxAmount       Int      @default(0)
  feeAmount       Int      @default(0) // Processing fees
  totalAmount     Int      // Final amount

  // Timing
  dueDate         DateTime? // When payment is due
  paidAt          DateTime? // When payment was completed
  failedAt        DateTime? // When payment failed
  refundedAt      DateTime? // When payment was refunded
  refundReason    String?  // Reason for refund
  nextBillingDate DateTime? // For recurring payments

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?  // Who created this transaction (user_id or system)

  // Relations
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id])
  invoice         Invoice?     @relation(fields: [invoiceId], references: [id])

  @@index([userId])
  @@index([subscriptionId])
  @@index([invoiceId])
  @@index([type])
  @@index([status])
  @@index([amount])
  @@index([currency])
  @@index([dueDate])
  @@index([paidAt])
  @@index([createdAt])
  @@index([externalTransactionId])
}

// Invoice Records
model Invoice {
  id              String   @id @default(cuid())
  userId          String
  subscriptionId  String?
  invoiceNumber   String   @unique // Format: INV/202410/0001
  type            String   @default("subscription") // subscription, renewal, setup_fee, overage
  status          String   @default("draft") // draft, sent, paid, overdue, cancelled, refunded

  // Invoice Details
  description     String   // Invoice description
  periodStartDate DateTime? // For subscription periods
  periodEndDate   DateTime? // For subscription periods
  dueDate         DateTime // Payment due date
  issuedAt        DateTime @default(now())
  paidAt          DateTime? // When invoice was paid

  // Financial Details
  subtotal        Int      @default(0) // Subtotal before discounts/taxes
  discountAmount  Int      @default(0)
  taxAmount       Int      @default(0)
  totalAmount     Int      @default(0) // Total amount due
  currency        String   @default("IDR")

  // Line Items (JSON array)
  items           Json     // Invoice line items with descriptions, quantities, prices

  // Payment Information
  paymentMethod   String?  // Payment method used
  paymentUrl      String?  // Payment URL for online payment
  notes           String?  // Additional notes

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id])
  transactions Transaction[]

  @@index([userId])
  @@index([subscriptionId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([type])
  @@index([dueDate])
  @@index([issuedAt])
  @@index([paidAt])
  @@index([totalAmount])
  @@index([currency])
}

// Chatbot System with Subscription Integration
model Chatbot {
  id            String   @id @default(cuid())
  userId        String
  subscriptionId String  // Link to active subscription
  name          String
  description   String?
  persona       String?  // AI persona configuration
  model         String   @default("gpt-3.5-turbo")
  language      String   @default("id")
  status        String   @default("active") // active, inactive, suspended, archived

  // Configuration
  temperature    Float?   @default(0.7)
  maxTokens      Int?     @default(1000)
  systemPrompt   String?
  welcomeMessage String?

  // Access Control
  isPublic       Boolean  @default(false)
  domain         String?  // Custom domain if applicable

  // Usage Statistics
  totalMessages  Int      @default(0)
  totalTokens    Int      @default(0)
  lastUsedAt     DateTime?

  // Integration
  webhookUrl     String?
  apiKey         String?  // API key for external access

  // Metadata
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([createdAt])
  @@index([lastUsedAt])
}